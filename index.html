<!doctype html>
<html lang="sv">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Elpris SE4 – graf & lista (inkl. moms)</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  :root{
    --bg: transparent;
    --fg: #e8edf2;
    --muted: #cfe0f4;
    --grid: #253044;
    /* Dovare nivåfärger */
    --green: #2e8f5b;
    --yellow:#d9b43b;
    --red:   #c34a4a;
    --now:   #ffd166;
    --chip:  #1a2230;
    --chip-b:#2b3547;
    --chip-a:#2e3a52;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #wrap{display:flex;flex-direction:column;min-height:100%;gap:8px}

  /* Panel = endast graf/lista */
  .panel{position:relative;flex:1;min-height:260px}
  svg{width:100%;height:100%}

  .grid line{stroke:var(--grid);stroke-width:1}
  .yLabel{fill:var(--muted);font-size:16px}
  .xLabel{fill:var(--muted);font-size:15px}
  .bar{opacity:.95;rx:7;ry:7}
  .bar.now{fill:var(--now);filter:drop-shadow(0 0 6px rgba(255,209,102,.5))}
  .barLabel{
    fill:#ffffff;font-size:18px;font-weight:700;text-anchor:middle;dominant-baseline:middle;
    paint-order:stroke;stroke:#000;stroke-width:3px;stroke-opacity:.35;
  }

  /* Lista */
  .list{display:flex;flex-direction:column;gap:8px;padding:0 12px}
  .hdr,.rowItem{
    display:grid;grid-template-columns:140px 150px 1fr;gap:12px;align-items:center;
    padding:12px;border:1px solid rgba(60,75,95,.35);border-radius:12px;background:rgba(24,31,44,0.22)
  }
  .hdr{font-weight:700;background:rgba(24,31,44,0.32)}
  .cell-time,.cell-price{font-variant-numeric:tabular-nums;font-size:16px}
  .meter{position:relative;height:14px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
  .meter>.fill{height:100%;border-radius:999px}
  .nowRow{outline:2px solid var(--now);box-shadow:0 0 10px rgba(255,209,102,.35) inset}
  .lvlGreen{background:rgba(46,143,91,.10);border-color:rgba(46,143,91,.25)}
  .lvlYellow{background:rgba(217,180,59,.10);border-color:rgba(217,180,59,.25)}
  .lvlRed{background:rgba(195,74,74,.10);border-color:rgba(195,74,74,.25)}

  /* Footer under grafen (ingen overlay) */
  .footer{
    display:flex;flex-wrap:wrap;align-items:center;gap:10px;padding:10px 12px 12px
  }
  .title{font-weight:800;font-size:20px;letter-spacing:.2px;margin-right:6px}
  .stats{display:flex;gap:10px;flex-wrap:wrap}
  .badge{background:var(--chip);border:1px solid var(--chip-b);border-radius:10px;padding:6px 10px;font-size:14px}
  .meta{opacity:.95;font-size:15px;margin-left:auto;margin-right:6px}
  .group{display:flex;gap:10px}
  .btn{background:var(--chip);border:1px solid var(--chip-b);color:var(--fg);border-radius:12px;padding:10px 16px;font-size:15px;cursor:pointer}
  .btn.active{background:var(--chip-a);border-color:#3d4c6a}
</style>

<div id="wrap">
  <div class="panel">
    <svg id="chart" viewBox="0 0 1000 460" preserveAspectRatio="none" aria-label="Elprisgraf"></svg>
    <div id="list" class="list" style="display:none"></div>
  </div>

  <!-- All text/knappar här nere -->
  <div class="footer">
    <div class="title">Elpris SE4</div>
    <div class="stats">
      <span id="statRange" class="badge">–</span>
      <span id="statAvg"   class="badge">–</span>
      <span id="statLow"   class="badge">–</span>
      <span id="statHigh"  class="badge">–</span>
    </div>
    <div class="meta" id="stamp">–</div>
    <div class="group">
      <button class="btn active" data-day="today" id="btnToday">Idag</button>
      <button class="btn" data-day="tomorrow" id="btnTomorrow">Imorgon</button>
      <button class="btn active" data-mode="chart" id="btnChart">Graf</button>
      <button class="btn" data-mode="list" id="btnList">Lista</button>
    </div>
  </div>
</div>

<script>
(()=> {
  const TZ = "Europe/Stockholm";
  const VAT = 1.25;
  const $  = s => document.querySelector(s);

  const chart=$("#chart"), listEl=$("#list");
  const statRange=$("#statRange"), statAvg=$("#statAvg"), statLow=$("#statLow"), statHigh=$("#statHigh"), stamp=$("#stamp");
  const btnToday=$("#btnToday"), btnTomorrow=$("#btnTomorrow"), btnChart=$("#btnChart"), btnList=$("#btnList");

  const today = new Date(); const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1);

  const bust = () => `?v=${Date.now()}`;
  const URL_TODAY    = "./data/today.json"+bust();
  const URL_TOMORROW = "./data/tomorrow.json"+bust();

  let rowsToday=null, rowsTomorrow=null, currentDay="today", currentMode="chart";

  async function fetchJson(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json(); }

  function toSeries(rows){
    return rows.map(r=>{
      const ts=new Date(r.time_start), te=new Date(r.time_end);
      const value=(r.SEK_per_kWh||0)*100*VAT;
      const s=ts.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit',timeZone:TZ});
      const e=te.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit',timeZone:TZ});
      return {ts,te,value,label:s,labelRange:`${s} – ${e}`};
    });
  }

  function computeLevels(series){
    const arr=series.map(d=>d.value).slice().sort((a,b)=>a-b);
    const thr33=arr[Math.floor((arr.length-1)*0.33)];
    const thr66=arr[Math.floor((arr.length-1)*0.66)];
    series.forEach(d=>d.level=(d.value<=thr33)?"green":(d.value<=thr66)?"yellow":"red");
  }

  function nowRounded(){
    const n=new Date(new Date().toLocaleString('en-CA',{timeZone:TZ}));
    n.setSeconds(0,0); n.setMinutes(Math.floor(n.getMinutes()/15)*15); return n;
  }

  const nf0=new Intl.NumberFormat('sv-SE',{maximumFractionDigits:0});
  const fmt0=n=>nf0.format(n), fmt10=n=>nf0.format(Math.round(n/10)*10);

  function renderStats(series){
    const v=series.map(d=>d.value), lo=Math.min(...v), hi=Math.max(...v), avg=v.reduce((a,b)=>a+b,0)/v.length;
    const iLo=v.indexOf(lo), iHi=v.indexOf(hi);
    statRange.textContent=`Intervall: ${fmt10(lo)}–${fmt10(hi)} öre/kWh`;
    statAvg.textContent=`Medel: ${fmt0(avg)} öre/kWh`;
    statLow.textContent=`Lägst: ${fmt0(lo)} öre/kWh (${series[iLo].label})`;
    statHigh.textContent=`Högst: ${fmt0(hi)} öre/kWh (${series[iHi].label})`;
  }

  function drawChart(series){
    // extra plats i botten för x-etiketter; footer ligger utanför grafen
    const W=1000,H=460,padL=16,padR=60,padT=8,padB=56;
    chart.setAttribute("viewBox",`0 0 ${W} ${H}`); chart.innerHTML="";
    const vals=series.map(d=>d.value), vMin=Math.min(...vals), vMax=Math.max(...vals);
    const niceMax=Math.ceil(vMax/10)*10, niceMin=Math.floor(Math.min(vMin,0)/10)*10;
    const plotW=W-padL-padR, plotH=H-padT-padB, n=series.length, gap=2;
    const barW=Math.max((plotW-(n-1)*gap)/n,2);
    const yScale=v=>padT+(1-(v-niceMin)/(niceMax-niceMin))*plotH;
    const xAt=i=>padL+i*(barW+gap);

    // grid + y till höger
    const g=document.createElementNS("http://www.w3.org/2000/svg","g"); g.setAttribute("class","grid");
    for(let i=0;i<=5;i++){
      const val=niceMin+i*(niceMax-niceMin)/5, y=yScale(val);
      const line=document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1",padL); line.setAttribute("x2",W-padR);
      line.setAttribute("y1",y); line.setAttribute("y2",y); g.appendChild(line);
      const t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x",W-padR+8); t.setAttribute("y",y+5);
      t.setAttribute("text-anchor","start"); t.setAttribute("class","yLabel"); t.textContent=fmt0(val);
      g.appendChild(t);
    }
    chart.appendChild(g);

    const nowRef=nowRounded();

    for(let i=0;i<n;i++){
      const d=series[i], x=xAt(i), y=yScale(d.value), h=Math.max(1,(padT+plotH)-y);
      const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
      r.setAttribute("x",x); r.setAttribute("y",y); r.setAttribute("width",barW); r.setAttribute("height",h); r.setAttribute("rx","7"); r.setAttribute("ry","7");
      r.style.fill = (d.level==="green")?"var(--green)":(d.level==="yellow")?"var(--yellow)":"var(--red)";
      const same=(a,b)=>a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()&&a.getDate()==b.getDate()&&a.getHours()==b.getHours()&&a.getMinutes()==b.getMinutes();
      r.setAttribute("class", same(d.ts,nowRef) ? "bar now" : "bar");
      chart.appendChild(r);

      // x-etiketter nära staplarna
      const showLabel=(n===24) ? true : (i%4===0);
      if(showLabel){
        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x",x+barW/2); t.setAttribute("y",H-14);
        t.setAttribute("text-anchor","middle"); t.setAttribute("class","xLabel"); t.textContent=d.label;
        chart.appendChild(t);
      }

      // pris i stapeln om >= 30 öre
      if(d.value>=30 && h>32){
        const lbl=document.createElementNS("http://www.w3.org/2000/svg","text");
        lbl.setAttribute("class","barLabel");
        const cx=x+barW/2, cy=y+h/2;
        lbl.setAttribute("transform",`rotate(-90 ${cx} ${cy})`);
        lbl.setAttribute("x",cx); lbl.setAttribute("y",cy); lbl.textContent=fmt0(d.value);
        chart.appendChild(lbl);
      }
    }
  }

  function drawList(series){
    listEl.innerHTML="";
    const hdr=document.createElement("div"); hdr.className="hdr"; hdr.innerHTML="<div>Timme</div><div>Pris per kWh</div><div>Prisnivå</div>";
    listEl.appendChild(hdr);

    const nowRef=nowRounded();
    const vals=series.map(d=>d.value), vMin=Math.min(...vals), vMax=Math.max(...vals);

    for(const d of series){
      const row=document.createElement("div"); row.className="rowItem";
      row.classList.add(d.level==="green"?"lvlGreen":d.level==="yellow"?"lvlYellow":"lvlRed");
      const same=(a,b)=>a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()&&a.getDate()==b.getDate()&&a.getHours()==b.getHours()&&a.getMinutes()==b.getMinutes();
      if(same(d.ts,nowRef)) row.classList.add("nowRow");

      const cTime=document.createElement("div"); cTime.className="cell-time"; cTime.textContent=d.labelRange;
      const cPrice=document.createElement("div"); cPrice.className="cell-price"; cPrice.textContent=`${fmt0(d.value)} öre`;
      const cLevel=document.createElement("div");
      const meter=document.createElement("div"); meter.className="meter";
      const fill=document.createElement("div"); fill.className="fill";
      const pct=(d.value-vMin)/(vMax-vMin||1);
      fill.style.width=Math.round(pct*100)+"%";
      fill.style.background=(d.level==="green")?"var(--green)":(d.level==="yellow")?"var(--yellow)":"var(--red)";
      meter.appendChild(fill); cLevel.appendChild(meter);
      row.appendChild(cTime); row.appendChild(cPrice); row.appendChild(cLevel);
      listEl.appendChild(row);
    }
  }

  function stampDate(isToday){
    const f=new Intl.DateTimeFormat('sv-SE',{weekday:'short',day:'2-digit',month:'short'});
    stamp.textContent=(isToday?"Idag ":"Imorgon ")+f.format(isToday?today:tomorrow);
  }

  function render(){
    const rows=(currentDay==="today")?rowsToday:rowsTomorrow;
    if(!rows||!rows.length){ chart.innerHTML=""; listEl.innerHTML=""; return; }
    const series=toSeries(rows); computeLevels(series); renderStats(series); stampDate(currentDay==="today");
    if(currentMode==="chart"){ chart.style.display="block"; listEl.style.display="none"; drawChart(series); }
    else { chart.style.display="none"; listEl.style.display="flex"; drawList(series); }
  }

  function updateBtns(){
    btnToday.classList.toggle("active", currentDay==="today");
    btnTomorrow.classList.toggle("active", currentDay==="tomorrow");
    btnChart.classList.toggle("active", currentMode==="chart");
    btnList.classList.toggle("active", currentMode==="list");
  }

  async function init(){
    try{ rowsToday=await fetchJson(URL_TODAY); }catch{ rowsToday=[]; }
    try{ rowsTomorrow=await fetchJson(URL_TOMORROW); }catch{ rowsTomorrow=null; }
    if(!rowsTomorrow || !rowsTomorrow.length){ btnTomorrow.disabled=true; btnTomorrow.title="Imorgon-data ej publicerad ännu"; }
    render();
  }

  btnToday.onclick = ()=>{ currentDay="today"; updateBtns(); render(); };
  btnTomorrow.onclick = ()=>{ currentDay="tomorrow"; updateBtns(); render(); };
  btnChart.onclick = ()=>{ currentMode="chart"; updateBtns(); render(); };
  btnList.onclick  = ()=>{ currentMode="list";  updateBtns(); render(); };

  init();
  setInterval(init, 30*60*1000);
})();
</script>
</html>
