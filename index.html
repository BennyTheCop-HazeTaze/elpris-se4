<!doctype html>
<html lang="sv">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Elpris SE4 – inkl. moms (dagvy)</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
  :root{
    --fg:#e8edf2; --muted:#cfe0f4; --grid:#263347;
    --now:#ffd166;
    --green:#5fa878;   --yellow:#d8b44a;  --red:#c06060;  --blue:#5aa7d6;
    --chip:#1a2230; --chip-b:#2b3547; --chip-a:#2e3a52;
    --s:1;
  }
  html,body{height:100%;margin:0;background:transparent;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
  #wrap{height:100%;display:grid;grid-template-rows:1fr auto;min-height:0;gap:calc(6px*var(--s))}
  .panel{min-height:0;overflow:hidden}
  svg{width:100%;height:100%}
  .grid line{stroke:var(--grid);stroke-width:1}
  .yLabel{fill:var(--muted);font-size:calc(14px*var(--s))}
  .xLabel{fill:var(--muted);font-size:calc(13px*var(--s))}
  .bar{opacity:.95;rx:calc(7px*var(--s));ry:calc(7px*var(--s))}
  .bar.past{opacity:.5}
  .nowLine{stroke:var(--now);stroke-width:2.2;stroke-dasharray:4 3;opacity:.95}
  .nowDot{fill:var(--now);stroke:#000;stroke-width:calc(2px*var(--s));stroke-opacity:.35}
  .nowTag{fill:#fff;font-weight:800;text-anchor:middle;font-size:calc(14px*var(--s));
          paint-order:stroke;stroke:#000;stroke-width:calc(3px*var(--s));stroke-opacity:.35}
  /* torn-siffror (smala) */
  .digit{
    fill:#fff; font-weight:700; text-anchor:middle;
    font-family:"Roboto Condensed","Arial Narrow","Segoe UI",system-ui;
    paint-order:stroke; stroke:#000; stroke-width:calc(3px*var(--s)); stroke-opacity:.35;
  }
  .footer{display:flex;flex-wrap:wrap;align-items:center;gap:calc(8px*var(--s));padding:0 calc(8px*var(--s)) calc(4px*var(--s))}
  .title{font-weight:800;font-size:calc(18px*var(--s))}
  .badge{background:var(--chip);border:1px solid var(--chip-b);border-radius:calc(8px*var(--s));padding:calc(4px*var(--s)) calc(8px*var(--s));font-size:calc(12px*var(--s))}
  .meta{opacity:.95;font-size:calc(13px*var(--s));margin-left:auto}
  .group{display:flex;gap:calc(6px*var(--s));flex-wrap:wrap}
  .btn{background:var(--chip);border:1px solid var(--chip-b);color:var(--fg);border-radius:calc(10px*var(--s));padding:calc(6px*var(--s)) calc(10px*var(--s));font-size:calc(13px*var(--s));cursor:pointer}
  .btn.active{background:var(--chip-a);border-color:#3d4c6a}
</style>

<div id="wrap">
  <div class="panel">
    <svg id="chart" viewBox="0 0 1000 360" preserveAspectRatio="none" aria-label="Elprisgraf"></svg>
  </div>
  <div class="footer">
    <div class="title">Elpris SE4</div>
    <span id="liveNow" class="badge">Just nu: –</span>
    <span id="statRange" class="badge">–</span>
    <span id="statAvg"   class="badge">–</span>
    <span id="statLow"   class="badge">–</span>
    <span id="statHigh"  class="badge">–</span>
    <div class="meta" id="stamp">–</div>
    <div class="group">
      <button class="btn" id="btnToday">Idag</button>
      <button class="btn" id="btnTomorrow">Imorgon</button>
    </div>
  </div>
</div>

<script>
(()=> {
  const TZ="Europe/Stockholm", VAT=1.25, $=s=>document.querySelector(s);
  const chart=$("#chart");
  const statRange=$("#statRange"), statAvg=$("#statAvg"), statLow=$("#statLow"), statHigh=$("#statHigh"), stamp=$("#stamp"), liveNow=$("#liveNow");
  const btnToday=$("#btnToday"), btnTomorrow=$("#btnTomorrow");

  new ResizeObserver(es=>{
    for(const e of es){
      const s=Math.max(0.55, Math.min(1.1, e.contentRect.height/340));
      document.documentElement.style.setProperty('--s', s.toFixed(3));
    }
  }).observe(document.querySelector('#wrap'));

  const bust=()=>`?v=${Date.now()}`;
  const URL_TODAY="./data/today.json"+bust(), URL_TOMORROW="./data/tomorrow.json"+bust();

  let rowsToday=null, rowsTomorrow=null;

  async function fetchJson(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json(); }

  function toSeries(rows){
    return rows.map(r=>{
      const ts=new Date(r.time_start), te=new Date(r.time_end);
      const value=(r.SEK_per_kWh||0)*100*VAT;  // öre inkl. moms
      const label=ts.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit',timeZone:TZ});
      return {ts,te,value,label};
    });
  }
  function computeLevels(series){
    const arr=series.map(d=>d.value).slice().sort((a,b)=>a-b);
    const t33=arr[Math.floor((arr.length-1)*0.33)], t66=arr[Math.floor((arr.length-1)*0.66)];
    series.forEach(d=>{
      if(d.value<0) d.level="neg";
      else d.level=(d.value<=t33)?"green":(d.value<=t66)?"yellow":"red";
    });
  }
  const nf0=new Intl.NumberFormat('sv-SE',{maximumFractionDigits:0});
  const nf2=new Intl.NumberFormat('sv-SE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmt0=n=>nf0.format(n), fmt10=n=>nf0.format(Math.round(n/10)*10);

  function renderStats(series){
    const v=series.map(d=>d.value), lo=Math.min(...v), hi=Math.max(...v), avg=v.reduce((a,b)=>a+b,0)/v.length;
    const iLo=v.indexOf(lo), iHi=v.indexOf(hi);
    const tf=d=>d.ts.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit',timeZone:TZ});
    statRange.textContent=`Intervall: ${fmt10(lo)}–${fmt10(hi)} öre/kWh`;
    statAvg.textContent  =`Medel: ${fmt0(avg)} öre/kWh`;
    statLow.textContent  =`Lägst: ${fmt0(lo)} öre/kWh (${tf(series[iLo])})`;
    statHigh.textContent =`Högst: ${fmt0(hi)} öre/kWh (${tf(series[iHi])})`;
  }
  function stampDate(isToday){
    const f=new Intl.DateTimeFormat('sv-SE',{weekday:'short',day:'2-digit',month:'short'});
    stamp.textContent=(isToday?"Idag ":"Imorgon ")+f.format(isToday?new Date():new Date(Date.now()+86400000));
  }

  function drawFullDay(series){
    const W=1000,H=360,padL=12,padR=64,padT=6;
    const s=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--s'))||1;
    const padB=Math.max(22, 38*s);
    chart.setAttribute("viewBox",`0 0 ${W} ${H}`); chart.innerHTML="";

    const vals=series.map(d=>d.value), vMin=Math.min(...vals), vMax=Math.max(...vals);
    const niceMax=Math.ceil(vMax/10)*10, niceMin=Math.floor(Math.min(vMin,0)/10)*10;
    const plotW=W-padL-padR, plotH=H-padT-padB;

    const n=series.length;
    const ideal=plotW/n;
    let gap=Math.max(0.5, Math.round(ideal*0.08));
    let barW=ideal-gap;
    if(barW<10){ gap=0.5; barW=Math.max(7.5, plotW/n-gap); }

    const yScale=v=>padT+(1-(v-niceMin)/(niceMax-niceMin))*plotH;
    const xAt=i=>padL+i*(barW+gap);

    // Grid + Y labels
    const g=document.createElementNS("http://www.w3.org/2000/svg","g"); g.setAttribute("class","grid");
    for(let i=0;i<=5;i++){
      const val=niceMin+i*(niceMax-niceMin)/5, y=yScale(val);
      const line=document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1",padL); line.setAttribute("x2",W-padR);
      line.setAttribute("y1",y); line.setAttribute("y2",y); g.appendChild(line);
      const t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x",W-padR+8); t.setAttribute("y",y+5);
      t.setAttribute("text-anchor","start"); t.setAttribute("class","yLabel"); t.textContent=fmt0(val);
      g.appendChild(t);
    }
    chart.appendChild(g);

    // Nu-slot via ts <= now < te
    const now = new Date();
    const idxNow = series.findIndex(d => now>=d.ts && now<d.te);

    // Dimma vänstra sidan (gardin)
    if(idxNow>0){
      const leftW = xAt(idxNow) - padL;
      const shade=document.createElementNS("http://www.w3.org/2000/svg","rect");
      shade.setAttribute("x",padL); shade.setAttribute("y",padT);
      shade.setAttribute("width",leftW); shade.setAttribute("height",H-padT-padB);
      shade.setAttribute("fill","#000"); shade.setAttribute("fill-opacity","0.18");
      chart.appendChild(shade);
    }

    // NU-linje + punkt + text (punkt och text lite högre)
    if(idxNow>=0){
      const d=series[idxNow];
      const x=xAt(idxNow)+barW/2; const y=yScale(d.value);
      const nl=document.createElementNS("http://www.w3.org/2000/svg","line");
      nl.setAttribute("x1",x); nl.setAttribute("x2",x); nl.setAttribute("y1",padT); nl.setAttribute("y2",H-padB);
      nl.setAttribute("class","nowLine"); chart.appendChild(nl);

      const dot=document.createElementNS("http://www.w3.org/2000/svg","circle");
      dot.setAttribute("cx",x); dot.setAttribute("cy",y - 6*s);          /* upp lite */
      dot.setAttribute("r",Math.max(4,6*s)); dot.setAttribute("class","nowDot"); chart.appendChild(dot);

      const tag=document.createElementNS("http://www.w3.org/2000/svg","text");
      tag.setAttribute("x",x);
      tag.setAttribute("y",Math.max(padT+26*s, y - 18*s));               /* högre etikett */
      tag.setAttribute("class","nowTag");
      tag.textContent=`Nu ${nf0.format(Math.round(d.value))} öre`; chart.appendChild(tag);

      liveNow.textContent=`Just nu: ${nf2.format(d.value/100)} kr/kWh (${d.label})`;
    } else {
      liveNow.textContent="Just nu: –";
    }

    // X-etiketter (heltimme vid kvartstaxa)
    const isQuarter = n>48;
    let every=1; if(barW<28) every=2; if(barW<20) every=3; if(barW<15) every=4;

    // Siffror som VERTIKALT TORN i varje stapel
    function drawStackedDigits(xCenter, yTop, height, value, minFont){
      // ta bara heltal i öre, inga mellanslag
      let str = String(Math.round(value));
      // om negativt värde: lägg '−' överst i tornet
      const neg = str[0]==='-' || str[0]==='−';
      if(neg) str = str.replace('-', '').replace('−','');

      const digits = str.split('');                // t.ex. ['4','7']
      const neededLines = digits.length + (neg?1:0);
      const maxFont = 12 * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--s'))||1);
      // beräkna font så att allt får plats
      let font = Math.min(maxFont, Math.max(minFont, (height-6) / (neededLines*1.15)));
      if(!isFinite(font) || font<minFont) font=minFont;

      const line = font*1.05;                      // radavstånd
      let y = yTop + height - 4;                   // starta nära botten

      // rita siffror nerifrån och upp
      for(let i=0;i<digits.length;i++){
        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("class","digit");
        t.setAttribute("x",xCenter);
        t.setAttribute("y",y - i*line);
        t.setAttribute("font-size",font);
        t.textContent=digits[i];
        chart.appendChild(t);
      }
      // lägg negativ-symbolen överst vid behov
      if(neg){
        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("class","digit");
        t.setAttribute("x",xCenter);
        t.setAttribute("y",y - digits.length*line);
        t.setAttribute("font-size",font);
        t.textContent="−";
        chart.appendChild(t);
      }
    }

    for(let i=0;i<n;i++){
      const d=series[i], x=xAt(i), y=yScale(d.value), h=Math.max(1,(H-padB)-y);

      const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
      r.setAttribute("x",x); r.setAttribute("y",y); r.setAttribute("width",barW); r.setAttribute("height",h);
      r.style.fill = d.value<0 ? "var(--blue)" :
                     d.level==="green" ? "var(--green)" :
                     d.level==="yellow" ? "var(--yellow)" : "var(--red)";
      if(i<idxNow) r.classList.add("bar","past"); else r.classList.add("bar");
      chart.appendChild(r);

      // torn av siffror inifrån stapeln
      drawStackedDigits(x+barW/2, y, h, d.value, 8);

      const showX=(i%every===0) && (isQuarter ? (d.ts.getMinutes()===0) : true);
      if(showX){
        const t=document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x",x+barW/2); t.setAttribute("y",H-6);
        t.setAttribute("text-anchor","middle"); t.setAttribute("class","xLabel"); t.textContent=d.label;
        chart.appendChild(t);
      }
    }
  }

  function renderAll(rows,isToday){
    const series=toSeries(rows);
    computeLevels(series);
    renderStats(series);
    stampDate(isToday);
    drawFullDay(series);
  }

  async function init(){
    try{ rowsToday=await fetchJson(URL_TODAY);}catch{ rowsToday=[]; }
    try{ rowsTomorrow=await fetchJson(URL_TOMORROW);}catch{ rowsTomorrow=null; }
    btnTomorrow.disabled = !(rowsTomorrow && rowsTomorrow.length);
    btnToday.classList.add("active");
    renderAll(rowsToday,true);
  }

  btnToday.onclick =()=>{ btnToday.classList.add("active"); btnTomorrow.classList.remove("active"); renderAll(rowsToday,true); };
  btnTomorrow.onclick=()=>{ if(btnTomorrow.disabled) return; btnTomorrow.classList.add("active"); btnToday.classList.remove("active"); renderAll(rowsTomorrow,false); };

  init();
  setInterval(init, 30*60*1000);
})();
</script>
</html>
